<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <UsingTask AssemblyFile="$(MSBuildThisFileDirectory)Sitecore.Demo.BuildTools.dll" TaskName="Sitecore.Demo.BuildTools.MergeXdtTransforms" />

  <Target Name="CollectXdtTransforms" Condition="'$(SitecoreDatabase)' != ''" AfterTargets="AfterSitecoreBuild">
    <Message Importance="high" Text="Collecting Config Transform Files..." />
    <CallTarget Targets="
                CollectConfigTransforms;
                MergeConfigTransforms;
                GenerateTransformsPayloadPackage"
                />
  </Target>

  <Target Name="CollectConfigTransforms" Condition="'$(BuildWebDeploy)' == 'True'">
    <ItemGroup>
      <_OutputConfigTransforms Include="$(_OutputPath)\transforms\**\*.xdt" />
      <_SolutionConfigTransforms Include="$(SolutionDir)\src\Foundation\**\code\**\*.xdt" />
      <_SolutionConfigTransforms Include="$(SolutionDir)\src\Feature\**\code\**\*.xdt" />
      <_SolutionConfigTransforms Include="$(SolutionDir)\src\Project\**\code\**\*.xdt" />
    </ItemGroup>

    <Message Importance="high" Text="Found file: %(_ConfigTransforms.Identity)" />

    <PropertyGroup>
      <_WebDeployFolder Condition="'$(OutDir)' != '$(OutputPath)' and '$(OutDir)' != ''">$(OutDir)_WebDeploy\$(MSBuildProjectName)\</_WebDeployFolder>
      <_WebDeployFolder Condition="'$(OutDir)' == '$(OutputPath)' or '$(OutDir)' == ''">$(OutputPath)..\WebDeploy_$(Configuration)\</_WebDeployFolder>
      <_ConfigTransformsSourceFolder>$(_WebDeployFolder)\XdtSource\</_ConfigTransformsSourceFolder>
      <_ConfigTransformsPayloadFolder>$(_WebDeployFolder)\TransformsPayload\</_ConfigTransformsPayloadFolder>
      <_ConfigTransformsTargetFolder>$(_ConfigTransformsPayloadFolder)\Xdts\</_ConfigTransformsTargetFolder>
    </PropertyGroup>

    <Copy
     SourceFiles="@(_OutputConfigTransforms)"
     DestinationFiles="@(_OutputConfigTransforms->'$(_ConfigTransformsSourceFolder)\transforms\%(RecursiveDir)%(Filename)%(Extension)')"
    />
    <Copy
     SourceFiles="@(_SolutionConfigTransforms)"
     DestinationFiles="@(_SolutionConfigTransforms->'$(_ConfigTransformsSourceFolder)\modules\%(RecursiveDir)%(Filename)%(Extension)')"
    />
  </Target>

  <Target Name="MergeConfigTransforms" DependsOnTargets="$(MergeConfigDependsOn)" Condition="'$(BuildWebDeploy)' == 'True'">

    <Message Importance="high" Text="Calling MergeConfigTransforms Task from: $(MSBuildThisFileDirectory) " />
    <ItemGroup>
      <_ConfigTransforms Include="$(_ConfigTransformsSourceFolder)\**\*.xdt" />
    </ItemGroup>

    <MergeXdtTransforms Transforms="@(_ConfigTransforms)" OutputPath="$(_ConfigTransformsTargetFolder)" />
    <RemoveDir Directories="$(_ConfigTransformsSourceFolder)" />
  </Target>

  <Target Name="GenerateTransformsPayloadPackage" Condition="'$(BuildWebDeploy)' == 'True'">

    <PropertyGroup>
      <_TransformsPayloadPackageName Condition=" '$(_TransformsPayloadPackageName)' == '' ">$(MSBuildProjectName)</_TransformsPayloadPackageName>
      <_TransformsPayloadPackageName Condition=" '$(WebDeployPackageName)' != '' ">$(WebDeployPackageName)</_TransformsPayloadPackageName>
      <_TransformsPayloadPackageName>$(_TransformsPayloadPackageName).Transforms</_TransformsPayloadPackageName>
    </PropertyGroup>

    <PropertyGroup Condition=" '$(WebDeployAppendDateAndTimeToPackageName)' == 'true' ">
      <_PackageDateTimeFormat Condition=" '$(PackageDateTimeFormat)' == '' ">yyyyMMdd_HHmm</_PackageDateTimeFormat>
      <_PackageDateTimeFormat Condition=" '$(PackageDateTimeFormat)' != '' ">$(PackageDateTimeFormat)</_PackageDateTimeFormat>
      <_TransformsPayloadPackageName>$(_TransformsPayloadPackageName)_$([System.DateTime]::Now.ToString("$(_PackageDateTimeFormat)"))</_TransformsPayloadPackageName>
    </PropertyGroup>

    <PropertyGroup>
      <_TransformsPayloadPackagePath>$(_WebDeployFolder)\$(_TransformsPayloadPackageName).sccpl</_TransformsPayloadPackagePath>
    </PropertyGroup>

    <Delete Files="$(_TransformsPayloadPackagePath)" Condition="Exists('$(_TransformsPayloadPackagePath)')" />
    <ZipDirectory
           SourceDirectory="$(_ConfigTransformsPayloadFolder)"
           DestinationFile="$(_TransformsPayloadPackagePath)" />

    <RemoveDir Directories="$(_ConfigTransformsPayloadFolder)" />

  </Target>

  <Target AfterTargets="AfterWebDeployPackage" Name="GenerateSCWebDeployPackage" Condition="'$(BuildWebDeploy)' == 'True'">
    <Message Importance="high" Text="Generating Sitecore Web Deploy Base package.." />

    <PropertyGroup>
      <_WebDeployPackageSourceFile>$(_WebDeployFolder)\$(WebDeployPackageName).wdp.zip</_WebDeployPackageSourceFile>
      <_WebDeploySitecorePackageTargetFile>$(_WebDeployFolder)\$(WebDeployPackageName).Base.scwdp.zip</_WebDeploySitecorePackageTargetFile>
      <_WebDeployUpdatedSitecorePackageFolder>$(_WebDeployFolder)\$(WebDeployPackageName)\</_WebDeployUpdatedSitecorePackageFolder>
      <_WebDeployUpdatedSitecorePackageTargetFile>$(_WebDeployFolder)\$(WebDeployPackageName).scwdp.zip</_WebDeployUpdatedSitecorePackageTargetFile>
    </PropertyGroup>
  
    <Message Importance="high" Text="Generating Sitecore Web Deploy package with embedded transforms.." />

    <Delete Files="$(_WebDeploySitecorePackageTargetFile)" Condition="Exists('$(_WebDeploySitecorePackageTargetFile)')" />
    <Unzip SourceFiles="$(_WebDeployPackageSourceFile)" DestinationFolder="$(_WebDeployUpdatedSitecorePackageFolder)" OverwriteReadOnlyFiles="true" ContinueOnError="true" />
    <Copy SourceFiles="$(_TransformsPayloadPackagePath)" DestinationFolder="$(_WebDeployUpdatedSitecorePackageFolder)\Content\Website\App_Data\Transforms\" />
    <ZipDirectory SourceDirectory="$(_WebDeployUpdatedSitecorePackageFolder)" DestinationFile="$(_WebDeployUpdatedSitecorePackageTargetFile)" />
    
    <RemoveDir Directories="$(_WebDeployUpdatedSitecorePackageFolder)" /> 
  </Target>

</Project>